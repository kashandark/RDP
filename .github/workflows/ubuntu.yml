name: Cockpit-Access

on:
  workflow_dispatch:

jobs:
  secure-cockpit:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update and Install Cockpit
        run: |
          sudo apt-get update -y
          sudo apt-get install -y cockpit

          # Enable and start Cockpit service
          sudo systemctl enable --now cockpit.socket

          # Allow Cockpit through firewall (if UFW is available)
          if command -v ufw &>/dev/null; then
            sudo ufw allow 9090/tcp || true
          fi

      - name: Create Cockpit User with Secure Password
        run: |
          # Generate a secure random password
          PASSWORD=$(tr -dc A-Za-z0-9_@#%+ | head -c16)
          sudo useradd -m -s /bin/bash cockpitadmin
          echo "cockpitadmin:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo cockpitadmin

          echo "COCKPIT_CREDS=User: cockpitadmin | Password: $PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable --now tailscaled

      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-cockpit-${{ github.run_id }}

          # Retrieve Tailscale IP
          TS_IP=$(tailscale ip -4)
          if [ -z "$TS_IP" ]; then
            echo "Tailscale IP not assigned. Exiting."
            exit 1
          fi

          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Verify Cockpit Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          nc -zv $TAILSCALE_IP 9090
          if [ $? -ne 0 ]; then
            echo "Cockpit port (9090) not reachable"
            exit 1
          fi
          echo "Cockpit is reachable on $TAILSCALE_IP:9090"

      - name: Maintain Session for Remote Access
        run: |
          echo ""
          echo "=== COCKPIT ACCESS ==="
          echo "URL: https://$TAILSCALE_IP:9090"
          echo "Username: cockpitadmin"
          echo "Password: $COCKPIT_CREDS"
          echo "======================="
          echo ""
          
          # Keep alive indefinitely for remote admin
          while true; do
            echo "[$(date)] Cockpit active. Access via Tailscale IP above."
            sleep 300
          done
