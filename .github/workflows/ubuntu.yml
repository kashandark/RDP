name: SSH (Ubuntu)

on:
  workflow_dispatch:

jobs:
  secure-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Configure System & SSH
        run: |
          sudo apt-get update -y
          sudo apt-get install -y openssh-server

          # Enable and configure SSH service
          sudo systemctl enable ssh
          sudo systemctl start ssh

          # Allow SSH from firewall (ufw)
          sudo ufw allow 22/tcp || true

          # Harden SSH: disable root login and enable password authentication
          sudo sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Create SSH User with Secure Password
        run: |
          # Generate secure random password
          openssl rand -base64 16 > password.txt
          PASS=$(cat password.txt)

          # Create new user
          sudo useradd -m -s /bin/bash sshuser
          echo "sshuser:$PASS" | sudo chpasswd
          sudo usermod -aG sudo sshuser

          echo "SSH_CREDS=User: sshuser | Password: $PASS" >> $GITHUB_ENV
          echo "SSH_PASSWORD=$PASS" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        env:
          TAILSCALE_AUTH_KEY_UBUNTU: ${{ secrets.TAILSCALE_AUTH_KEY_UBUNTU }}
        run: |
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY_UBUNTU} --hostname=gh-ubuntu-${GITHUB_RUN_ID}

          # Wait until Tailscale IP is assigned
          for i in {1..10}; do
            TS_IP=$(tailscale ip -4 | head -n1)
            if [ -n "$TS_IP" ]; then
              echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
              break
            fi
            sleep 5
          done

          if [ -z "$TS_IP" ]; then
            echo "Tailscale IP not assigned. Exiting."
            exit 1
          fi

      - name: Verify SSH Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          nc -zv $TAILSCALE_IP 22 || (echo "SSH port not reachable" && exit 1)
          echo "SSH connectivity successful!"

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== SSH ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Username: sshuser"
          echo "Password: $SSH_PASSWORD"
          echo "=================="
          echo ""
          echo "Keeping workflow alive for SSH session..."
          while true; do
            echo "[$(date)] SSH Active - Cancel workflow to terminate"
            sleep 300
          done
