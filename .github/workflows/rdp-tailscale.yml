name: RDP over Tailscale (Windows)

on:
  workflow_dispatch:

jobs:
  rdp-tailscale:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP and Create User
        run: |
          Write-Host "Enabling RDP and creating user..."
          net user rdpuser P@ssw0rd123! /add
          net localgroup administrators rdpuser /add
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "✅ RDP enabled and user created."

      - name: Install Tailscale
        run: |
          Write-Host "Installing Tailscale..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $msi
          Start-Process msiexec.exe -Wait -ArgumentList "/i $msi /qn"
          Write-Host "✅ Tailscale installed."

      - name: Connect to Tailscale Network
        run: |
          $hostname = "gh-runner-$env:GITHUB_RUN_ID"
          Write-Host "Bringing Tailscale up as $hostname..."

          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_DEVICE_KEY }} `
            --hostname=$hostname `
            --accept-routes `
            --accept-dns=false `
            --unattended

          Start-Sleep -Seconds 10
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          if (-not $tsIP) {
              Write-Host "⚠️ No IP yet. Checking status..."
              & "$env:ProgramFiles\Tailscale\tailscale.exe" status
              Write-Error "❌ Still no Tailscale IP. Likely an invalid or expired key."
              exit 1
          }

          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "✅ Connected! Tailscale IP: $tsIP"

      - name: Display Connection Details
        run: |
          Write-Host "========================================"
          Write-Host "✅ RDP Access Ready"
          Write-Host "User: rdpuser"
          Write-Host "Pass: P@ssw0rd123!"
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "========================================"

      - name: Keep RDP Alive
        run: |
          Write-Host "RDP session active. Keep this workflow running."
          while ($true) {
              Start-Sleep -Seconds 300
          }
