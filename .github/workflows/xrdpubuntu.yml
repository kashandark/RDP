name: RDP over Tailscale (Ubuntu)

on:
  workflow_dispatch:

jobs:
  rdp-tailscale:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update System
        run: |
          sudo apt update -y
          sudo apt upgrade -y

      - name: Create RDP User
        run: |
          sudo useradd -m rdpuser
          echo "rdpuser:P@ssw0rd123!" | sudo chpasswd
          sudo usermod -aG sudo rdpuser

      - name: Install Desktop Environment + xRDP
        run: |
          sudo apt install -y xfce4 xfce4-goodies xrdp dbus-x11
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sudo adduser xrdp ssl-cert
          echo xfce4-session > ~/.xsession
          sudo systemctl restart xrdp

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Connect to Tailscale Network
        run: |
          HOSTNAME="gh-ubuntu-${{ github.run_id }}"
          echo "Connecting to Tailscale as $HOSTNAME"

          # ✅ correct tailscale flags for GitHub runners
          sudo tailscale up \
            --auth-key=${{ secrets.TAILSCALE_DEVICE_KEY }} \
            --hostname=$HOSTNAME \
            --accept-routes \
            --accept-dns=false \
            --reset

          sleep 5

          tsIP=$(tailscale ip -4)

          if [ -z "$tsIP" ]; then
            echo "❌ No Tailscale IP. Checking status..."
            sudo tailscale status
            exit 1
          fi

          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "✅ Connected to Tailscale with IP: $tsIP"

      - name: Display Connection Details
        run: |
          echo "========================================"
          echo "✅ Ubuntu RDP Access Ready"
          echo "User: rdpuser"
          echo "Pass: P@ssw0rd123!"
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "========================================"

      - name: Keep Alive
        run: |
          echo "RDP session active. Do NOT stop the workflow."
          while true; do
            sleep 300
          done
