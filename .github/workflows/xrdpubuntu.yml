name: Ubuntu Tailscale Connect

on:
  workflow_dispatch:

jobs:
  tailscale:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install Tailscale
        run: |
          echo "Installing Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh
          echo "✅ Installed."

      - name: Connect to Tailscale
        run: |
          echo "Bringing Tailscale online..."
          HOSTNAME="gh-ubuntu-${{ github.run_id }}"

          # ✅ valid flags for GitHub runner version
          sudo tailscale up \
            --auth-key=${{ secrets.TAILSCALE_DEVICE_KEY }} \
            --hostname=$HOSTNAME \
            --accept-routes \
            --accept-dns=false \
            --reset

          sleep 5

          TS_IP=$(tailscale ip -4)
          if [ -z "$TS_IP" ]; then
            echo "❌ No Tailscale IP. Checking status..."
            sudo tailscale status
            exit 1
          fi

          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "✅ Connected. Tailscale IP: $TS_IP"

      - name: Output Connection Info
        run: |
          echo "==============================="
          echo "✅ Tailscale Connection Active"
          echo "IP: $TAILSCALE_IP"
          echo "Hostname: gh-ubuntu-${{ github.run_id }}"
          echo "==============================="

      - name: Keep Session Alive
        run: |
          echo "Runner active. Keep workflow running."
          while true; do
            sleep 300
          done
